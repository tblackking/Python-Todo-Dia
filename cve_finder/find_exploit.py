import subprocess
import json
import csv

def buscar_detalhes_exploitdb(cve_id):
    try:
        resultado = subprocess.check_output(['searchsploit', '--cve', cve_id, '-j'], stderr=subprocess.DEVNULL)
        dados = json.loads(resultado.decode())
        return dados['RESULTS_EXPLOIT'] if dados['RESULTS_EXPLOIT'] else None
    except Exception:
        return None

def carregar_lista_cves(caminho_arquivo):
    with open(caminho_arquivo, 'r') as f:
        return [linha.strip() for linha in f if linha.strip()]

def salvar_resultado_csv(resultados, nome_arquivo='resultado_exploits.csv'):
    with open(nome_arquivo, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['CVE', 'Exploit(s)'])
        for cve, exploits in resultados.items():
            if exploits:
                for exploit in exploits:
                    writer.writerow([cve, f"{exploit['Title']} ({exploit['Path']})"])
            else:
                writer.writerow([cve, 'No Exploit'])

def main():
    caminho_arquivo = 'list_cves_to_verify.txt'  # Arquivo com CVEs, uma por linha
    cves = carregar_lista_cves(caminho_arquivo)
    resultados = {}

    print("[*] Verificando exploits no Exploit-DB...")
    for cve in cves:
        print(f"   - {cve}...", end=' ')
        exploits = buscar_detalhes_exploitdb(cve)
        if exploits:
            print(f"{len(exploits)} encontrado(s).")
        else:
            print("Nenhum exploit encontrado.")
        resultados[cve] = exploits

    salvar_resultado_csv(resultados)
    print("\n[+] Verificação concluída. Arquivo 'resultado_exploits.csv' gerado com sucesso.")

if __name__ == '__main__':
    main()
